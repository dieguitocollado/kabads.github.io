<!DOCTYPE html>
<html lang="en-us">
<head>
  
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-28792208-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-28792208-1');
</script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <title>Setting Up MySQL Replication as a back-up solution - Kabads - musings, mutterings and murmerings</title>
  <meta property="og:title" content="Setting Up MySQL Replication as a back-up solution - Kabads - musings, mutterings and murmerings" />
  <meta name="twitter:title" content="Setting Up MySQL Replication as a back-up solution - Kabads - musings, …" />
  <meta name="description" content="Introduction MySQL servers can be a single point of failure if you have not set up a good back-up infrastructure. It is difficult to get a good back-up infrastructure in place, without some time spent out of service. However, a MySQL replication server avoids this downtime.
One server will act as the master, and the other will act as slave. The slave will be paused and then backed up.">
  <meta property="og:description" content="Introduction MySQL servers can be a single point of failure if you have not set up a good back-up infrastructure. It is difficult to get a good back-up infrastructure in place, without some time spent out of service. However, a MySQL replication server avoids this downtime.
One server will act as the master, and the other will act as slave. The slave will be paused and then backed up.">
  <meta name="twitter:description" content="Introduction MySQL servers can be a single point of failure if you have not set up a good back-up infrastructure. It is difficult to get a good back-up infrastructure in place, without some time spent …">
  <meta name="author" content=""/>
  <meta property="og:site_name" content="Kabads - musings, mutterings and murmerings" />
  <meta property="og:url" content="/post/2018-08-27-setting-up-mysql-replication/" />
  <meta property="og:type" content="article" />
  <meta name="twitter:card" content="summary" />
  <meta name="generator" content="Hugo 0.54.0" />
  <link rel="stylesheet" href="/css/style.css" media="all" />
  <link rel="stylesheet" href="/css/syntax.css" media="all" />
  <link rel="stylesheet" href="/css/custom.css" media="all" />
  <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
</head>

<body>

<header class="site-header">
  <nav class="site-navi">
    <h1 class="site-title"><a href="/">Kabads - musings, mutterings and murmerings</a></h1>
    <ul class="site-navi-items">
      <li class="site-navi-item-categories"><a href="/categories/" title="Categories">Categories</a></li>
      <li class="site-navi-item-about"><a href="/about/" title="About">About</a></li>
    </ul>
  </nav>
</header>
<hr class="site-header-bottom">

  <div class="main" role="main">
    <article class="article">
      
      
      <h1 class="article-title">Setting Up MySQL Replication as a back-up solution</h1>
      
      <hr class="article-title-bottom">
      <ul class="article-meta">
        <li class="article-meta-date"><time>August 27, 2018</time></li>
        <li class="article-meta-categories">
          <a href="/categories/sysadmin/">
            <svg class="icon"><use xlink:href="/images/fa-solid.svg#folder"></use></svg>
            sysadmin
          </a>&nbsp;
        </li>
      </ul>
      
<aside class="toc">
  <nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#benefits-of-running-a-replicated-mysql-server">Benefits of running a replicated MySQL server:</a></li>
<li><a href="#conifgure-the-master-mysql-server">Conifgure the Master MySQL server</a></li>
<li><a href="#configuring-the-mysql-slave-server">Configuring the MySQL slave Server</a></li>
<li><a href="#enabling-replication-on-an-existing-database">Enabling replication on an existing database</a></li>
<li><a href="#carry-out-the-backup">Carry out the backup</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
</aside>
      

<h3 id="introduction">Introduction</h3>

<p>MySQL servers can be a single point of failure if you have not set up a good back-up infrastructure. It is difficult to get a good back-up infrastructure in place, without some time spent out of service. However, a MySQL replication server avoids this downtime.</p>

<p>One server will act as the master, and the other will act as slave. The slave will be paused and then backed up.</p>

<h3 id="benefits-of-running-a-replicated-mysql-server">Benefits of running a replicated MySQL server:</h3>

<ul>
<li>Remove single point of failure adding high availability</li>
<li>Improved performance if applications can use the read-only server (think data querying)</li>
</ul>

<p><img src="https://s3.eu-west-2.amazonaws.com/kabads.monkeez.org/images/mysql_replication.png" alt="Master/Slave Server diagram" /></p>

<h3 id="conifgure-the-master-mysql-server">Conifgure the Master MySQL server</h3>

<p>The master is the live database that is serving your users. To back this up on it&rsquo;s own, you will have to stop transactions on the server and then carry out the backup. In a lot of high availability environments, this is not an option. However, you can prepare your master MySQL server to send those transactions to a different server.</p>

<p>In <code>/etc/my.conf</code> add the following lines:</p>

<pre><code>log-bin       = master-bin
log-bin-index = master-bin.index
server-id      = 1
</code></pre>

<p>The <code>log-bin</code> directive tells mysql to store a binary log. This binary log is what makes replication easy and quick. We also have a <code>log-index</code>. The binary log tells the other server the events that are happening on the master server.</p>

<p>You can watch the binary log file with the mysql prompt with <code>SHOW BINLOG EVENTS\G;</code>. However, to find out which binlog file is currently being written to you should enter <code>SHOW MASTER STATUS;</code> and then <code>SHOW BINLOG EVENTS IN 'master-bin.000002'\G;</code> (or whatever file was returned from the master status command.</p>

<p>If you added the replication config lines above after creating the server, as opposed to when you first set the server up, you will need to restart the mysql server:</p>

<pre><code>service mysql-server restart
</code></pre>

<p>Then you will need to login to the MySQL command prompt:</p>

<pre><code>mysql -u root
</code></pre>

<p>Next, it is good practise to create a user for replication that only has access rights for the IP range for the subnet where the slave server is.</p>

<pre><code>CREATE USER repl_user; 
GRANT REPLICATION SLAVE ON *.*
TO repl_user IDENTIFIED BY 'password';
</code></pre>

<p>This user will have access to retrieve the binary log from the master server.</p>

<h3 id="configuring-the-mysql-slave-server">Configuring the MySQL slave Server</h3>

<p>Again, we need a user that has certain privileges on the slave server.</p>

<pre><code>GRANT REPLICATION, SLAVE, RELOAD, CREATE USER, SUPER ON *.* TO user@'1.2.3.%' WITH GRANT OPTION;
</code></pre>

<p>Next, you will have to log in to the slave mysql server and issue the following command:</p>

<pre><code>CHANGE MASTER TO MASTER_HOST = '1.2.3.4', MASTER_PORT = 3306, MASTER_USER = 'repl_user', MASTER_PASSWORD = 'password';
START SLAVE;
</code></pre>

<p>Any changes for new databases on the master server will now be replicated on the slave server.</p>

<h3 id="enabling-replication-on-an-existing-database">Enabling replication on an existing database</h3>

<p>If you already have a database on the master server, that you also want to replicate, you will need to copy it over to the slave database.</p>

<p>If the database is relatively small (i.e. less than 50MB), then the <code>mysqldump</code> command will work. Shutdown the database first to ensure data integrity.</p>

<p><code>mysqldump -u root -p databasename &gt; file.sql</code></p>

<p>If the dataset is large, then it will be better to create an archive of the files and then transfer that over to the slave machine and restart the server there. Firstly, you should shutdown the mysql server.</p>

<p>Then, on the slave server, copy the files in the database directory (usually <code>/var/lib/mysql</code>). You can then tar that and then copy to the slave server and extract there. If there are large differences between the configuration files between the servers, then this might not work.</p>

<h3 id="carry-out-the-backup">Carry out the backup</h3>

<p>Now that we have a slave, we can take point in time back-ups by stopping the slave and pausing transactions (although transactions are still ongoing on the master server).</p>

<ol>
<li><p>Shut down the server <code>sudo service mysql-server stop</code></p></li>

<li><p>Copy the data files to a secure off-site location (in this case, Amazon S3) <code>sudo aws s3 sync --delete /var/lib/mysql s3://bucket-name/</code></p></li>

<li><p>Restart the server <code>sudo service mysql-service start</code></p></li>
</ol>

    </article>

    
<ul class="article-share">
  <li>
    <a href="https://twitter.com/share" class="twitter-share-button">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  </li>
  <li>
    <div class="fb-share-button" data-href="https://kabads.monkeez.org/post/2018-08-27-setting-up-mysql-replication/" data-layout="button_count" data-action="like" data-size="small" data-show-faces="true" data-share="true"></div>
    <div id="fb-root"></div>
    <script>(function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v2.10";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));</script>
  </li>
  <li>
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <g:plus action="share"></g:plus>
  </li>
  <li>
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="basic-label-counter" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
  <li>
    <a data-pocket-label="pocket" data-pocket-count="horizontal" class="pocket-btn" data-lang="en"></a>
    <script>!function(d,i){if(!d.getElementById(i)){var j=d.createElement("script");j.id=i;j.src="https://widgets.getpocket.com/v1/j/btn.js?v=1";var w=d.getElementById(i);d.body.appendChild(j);}}(document,"pocket-btn-js");</script>
  </li>
</ul>

    <ul class="pager article-pager">
      <li class="pager-newer">
          <a href="/post/2019-03-10-using-fujitsu-snapscan-s1300i-on-arch/" data-toggle="tooltip" data-placement="top" title="Setting Up Fujitsu Snapscan S1300i on Arch Linux">&lt; Newer</a>
      </li>
      <li class="pager-older">
        <a href="/post/2018-08-11-configure-autofs/" data-toggle="tooltip" data-placement="top" title="Configure Autofs on Arch Linux">Older &gt;</a>
      </li>
    </ul>
  </div>


<div class="site-footer">
  <div class="copyright"></div>
  <ul class="site-footer-items">
  </ul>
  <div class="powerdby">
    Powered by <a href="https://gohugo.io/">Hugo</a>
  </div>
</div>
<script src="/js/script.js"></script>
<script src="/js/custom.js"></script>


</body>
</html>
